<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.aezen.www.repository.PointRepository">

  <!-- π“ ν¬μΈνΈ λ‚΄μ—­ μ΅°ν (λ„μ ν¬μΈνΈ ν¬ν•¨) -->
  <select id="getPointHistory" parameterType="string" resultType="com.aezen.www.vo.PointVO">
  SELECT 
      p.point_no AS pointNo,
      p.point_amount AS pointAmount,
      p.point_type AS pointType,
      p.point_reason AS pointReason,
      DATE_FORMAT(p.point_created_at, '%Y-%m-%d %H:%i:%s') AS pointCreatedAt,
      p.id,
      p.board_no AS boardNo,

      -- π’° λ„μ  ν¬μΈνΈ κ³„μ‚° (1=μ‚¬μ©β†’μ°¨κ°, 2=μ λ¦½β†’μ¶”κ°€)
      SUM(
        CASE 
          WHEN p.point_type = 1 THEN -p.point_amount   -- μ‚¬μ©μ΄λ©΄ λΉΌκΈ°
          WHEN p.point_type = 2 THEN p.point_amount    -- μ λ¦½μ΄λ©΄ λ”ν•κΈ°
          ELSE 0
        END
      ) OVER (
        ORDER BY p.point_created_at, p.point_no
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      ) AS cumulativePoint

  FROM point p
  WHERE p.id = #{id}
  ORDER BY p.point_created_at ASC, p.point_no DESC
</select>

  <!-- π’° ν¬μΈνΈ μ λ¦½ / μ‚¬μ© κΈ°λ΅ μ¶”κ°€ -->
  <insert id="insertPoint" parameterType="com.aezen.www.vo.PointVO">
  INSERT INTO point 
  (id, point_amount, point_type, point_reason, point_created_at)
  VALUES
  (#{id}, #{pointAmount}, #{pointType}, #{pointReason}, NOW());
</insert>

<!-- ν¬μΈνΈ μ¶”κ°€ μ‹ user ν…μ΄λΈ”μ ν„μ¬ μ”μ—¬ ν¬μΈνΈ μ—…λ°μ΄νΈ -->
<update id="updateUserCurrentPoint" parameterType="com.aezen.www.vo.PointVO">
  UPDATE user
  SET user_current_point = user_current_point +
  CASE 
    WHEN #{pointType} = 2 THEN #{pointAmount}  <!-- μ λ¦½ -->
    WHEN #{pointType} = 1 THEN -#{pointAmount} <!-- μ°¨κ° -->
    ELSE 0
  END
  WHERE id = #{id};
</update>
<!--  ν¬μΈνΈ μ‚­μ  -->
	<delete id="deletePoint" parameterType="int">
	  DELETE FROM point WHERE point_no = #{pointNo}
	</delete>
</mapper>
